"use strict";const HTML_TAGS=["doctype","html","head","title","base","link","meta","style","script","noscript","body","article","nav","aside","section","header","footer","h1-h6","hgroup","address","p","hr","pre","blockquote","ol","ul","li","dl","dt","dd","figure","figcaption","div","table","caption","thead","tbody","tfoot","tr","th","td","col","colgroup","form","fieldset","legend","label","input","button","select","datalist","optgroup","option","textarea","keygen","output","progress","meter","details","summary","command","menu","del","ins","img","iframe","embed","object","param","video","audio","source","canvas","track","map","area","a","em","strong","i","b","u","s","small","abbr","q","cite","dfn","sub","sup","time","code","kbd","samp","var","mark","bdi","bdo","ruby","rt","rp","span","br","wbr"];function createElementFromHTML(t){let e=document.createElement("template");return e.innerHTML=t.trim(),e.content.firstElementChild}function elementIs(t,e){return t.tagName.toLowerCase()===e.toLowerCase()}class RSS{constructor(t,e,n={}){this.version="1.0.0",this.target=t,this.url=e,this.html=[],this.effectQueue=[],this.options={ssl:!0,host:"www.feedrapp.info",support:!0,limit:null,key:null,layoutTemplate:"<ul>{entries}</ul>",entryTemplate:'<li><a href="{url}">[{author}@{date}] {title}</a><br/>{shortBodyPlain}</li>',tokens:{},outputMode:"json",dateFormat:"dddd MMM Do",dateLocale:"en",effect:"show",offsetStart:!1,offsetEnd:!1,error:function(t){console.log("Vanilla RSS: An error ocurred!",t,t.stack)},onData:function(){},success:function(){},...n}}render(){return new Promise(async(t,e)=>{const n=await this._load();try{this.feed=n.responseData.feed,this.entries=n.responseData.feed.entries}catch(t){return this.entries=[],this.feed=null,e(t)}const o=this._generateHTMLForEntries();if(this.target.append(o.layout),0!==o.entries.length){"function"==typeof this.options.onData&&this.options.onData.call(this);const t=elementIs(o.layout,"entries")?o.layout:o.layout.querySelector("entries");this._appendEntriesAndApplyEffects(t,o.entries)}this.effectQueue.length>0?this._executeEffectQueue(this.callback):t()})}_appendEntriesAndApplyEffects(t,e){e.forEach(e=>{var n=this._wrapContent(e);"show"===this.options.effect?t.insertAdjacentHTML("beforebegin",n.outerHTML):(n.style.display="none",t.insertAdjacentHTML("beforebegin",n.outerHTML),this._applyEffect(n,this.options.effect))}),t.remove()}_wrapContent(t){return 0!==t.trim().indexOf("<")?createElementFromHTML(`<div>${t}</div>`):createElementFromHTML(t)}_load(){let t=`${`${`http${this.options.ssl?"s":""}`}://${this.options.host}`}?support=${this.options.support}&version=${this.version}&q=${encodeURIComponent(this.url)}`;return this.options.offsetStart&&this.options.offsetEnd&&(this.options.limit=this.options.offsetEnd),null!==this.options.limit&&(t+=`&num=${this.options.limit}`),null!==this.options.key&&(t+=`&key=${this.options.key}`),this._fetchFeed(t)}async _fetchFeed(t){const e=await fetch(t,{headers:{"Content-Type":"application/json"}});return await e.json()}_generateHTMLForEntries(){const t={entries:[],layout:null};return this.entries.forEach((e,n)=>{const o=this.options.offsetStart,i=this.options.offsetEnd;let s;o&&i?n>=o&&n<=i&&this._isRelevant(e,t.entries)&&(s=this._evaluateStringForEntry(this.options.entryTemplate,e),t.entries.push(s)):this._isRelevant(e,t.entries)&&(s=this._evaluateStringForEntry(this.options.entryTemplate,e),t.entries.push(s))}),this.options.entryTemplate?t.layout=this._wrapContent(this.options.layoutTemplate.replace("{entries}","<entries></entries>")):t.layout=this._wrapContent("<div><entries></entries></div>"),t}_isRelevant(t,e){const n=this._getTokenMap(t);return!this.options.filter||(!this.options.filterLimit||this.options.filterLimit!==e.length)&&this.options.filter(t,n)}_applyEffect(t,e,n){}_executeEffectQueue(t){this.effectQueue.reverse();var e=()=>{var n=this.effectQueue.pop();n?this._applyEffect(n.element,n.effect,e):t&&t()};e()}_evaluateStringForEntry(t,e){var n=t;return(t.match(/(\{.*?\})/g)||[]).forEach(t=>{n=n.replace(t,this._getValueForToken(t,e))}),n}_getFormattedDate(t){if(this.options.dateFormatFunction)return this.options.dateFormatFunction(t);if("undefined"!=typeof moment){var e=moment(new Date(t));return(e=e.locale?e.locale(this.options.dateLocale):e.lang(this.options.dateLocale)).format(this.options.dateFormat)}return t}_getTokenMap(t){if(!this.feedTokens){var e=JSON.parse(JSON.stringify(this.feed));delete e.entries,this.feedTokens=e}return{feed:this.feedTokens,url:t.link,author:t.author,date:this._getFormattedDate(t.publishedDate),title:t.title,body:t.content,shortBody:t.contentSnippet,bodyPlain:function(t){for(var e=t.content.replace(/<script[\\r\\\s\S]*<\/script>/gim,"").replace(/<\/?[^>]+>/gi,""),n=0;n<HTML_TAGS.length;n++)e=e.replace(new RegExp("<"+HTML_TAGS[n],"gi"),"");return e}(t),shortBodyPlain:t.contentSnippet.replace(/<\/?[^>]+>/gi,""),index:this.entries.includes(t),totalEntries:this.entries.length,teaserImage:function(t){try{return t.content.match(/(<img.*?>)/gi)[0]}catch(t){return""}}(t),teaserImageUrl:function(t){try{return t.content.match(/(<img.*?>)/gi)[0].match(/src="(.*?)"/)[1]}catch(t){return""}}(t),...this.options.tokens}}_getValueForToken(t,e){var n=this._getTokenMap(e),o=n[t.replace(/[\{\}]/g,"")];if(void 0!==o)return"function"==typeof o?o(e,n):o;throw new Error("Unknown token: "+t+", url:"+this.url)}}module.exports=RSS;
