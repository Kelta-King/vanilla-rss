"use strict";const HTML_TAGS=["doctype","html","head","title","base","link","meta","style","script","noscript","body","article","nav","aside","section","header","footer","h1-h6","hgroup","address","p","hr","pre","blockquote","ol","ul","li","dl","dt","dd","figure","figcaption","div","table","caption","thead","tbody","tfoot","tr","th","td","col","colgroup","form","fieldset","legend","label","input","button","select","datalist","optgroup","option","textarea","keygen","output","progress","meter","details","summary","command","menu","del","ins","img","iframe","embed","object","param","video","audio","source","canvas","track","map","area","a","em","strong","i","b","u","s","small","abbr","q","cite","dfn","sub","sup","time","code","kbd","samp","var","mark","bdi","bdo","ruby","rt","rp","span","br","wbr"];class Ballyhoo{constructor(){this.topics={},this.hop=this.topics.hasOwnProperty}on(t,e){this.hop.call(this.topics,t)||(this.topics[t]=[]);const s=this.topics[t].push(e)-1;return{remove:()=>{this.topics[t].splice(s,1)}}}emit(t,e={}){return this.hop.call(this.topics,t)?this.topics[t].forEach(t=>t(e)):this}}function createElementFromHTML(t){let e=document.createElement("template");return e.innerHTML=t.trim(),e.content.firstElementChild}function elementIs(t,e){return t.tagName.toLowerCase()===e.toLowerCase()}class RSS{constructor(t,e,s={}){this.version="1.0.0",this.target=t,this.url=e,this.html=[],this.effectQueue=[],this.options={ssl:!0,host:"www.feedrapp.info",support:!0,limit:null,key:null,layoutTemplate:"<ul>{entries}</ul>",entryTemplate:'<li><a href="{url}">[{author}@{date}] {title}</a><br/>{shortBodyPlain}</li>',tokens:{},outputMode:"json",dateFormat:"dddd MMM Do",dateLocale:"en",effect:"show",offsetStart:!1,offsetEnd:!1,...s},this.events=new Ballyhoo}on(t,e){return this.events.on(`vanilla-rss/${t}`,e),this}render(){return new Promise(async(t,e)=>{try{const t=await this._load();this.feed=t.responseData.feed,this.entries=t.responseData.feed.entries}catch(t){return this.entries=[],this.feed=null,e(t)}const s=this._generateHTMLForEntries();if(this.target.append(s.layout),0!==s.entries.length){this.events.emit("vanilla-rss/data",{rss:this,feed:this.feed,entries:this.entries});const t=elementIs(s.layout,"entries")?s.layout:s.layout.querySelector("entries");this._appendEntriesAndApplyEffects(t,s.entries)}this.effectQueue.length>0?this._executeEffectQueue(this.callback):t()})}_appendEntriesAndApplyEffects(t,e){e.forEach(e=>{var s=this._wrapContent(e);"show"===this.options.effect?t.insertAdjacentHTML("beforebegin",s.outerHTML):(s.style.display="none",t.insertAdjacentHTML("beforebegin",s.outerHTML),this._applyEffect(s,this.options.effect))}),t.remove()}_wrapContent(t){return 0!==t.trim().indexOf("<")?createElementFromHTML(`<div>${t}</div>`):createElementFromHTML(t)}_load(){let t=`${`${`http${this.options.ssl?"s":""}`}://${this.options.host}`}?support=${this.options.support}&version=${this.version}&q=${encodeURIComponent(this.url)}`;return this.options.offsetStart&&this.options.offsetEnd&&(this.options.limit=this.options.offsetEnd),null!==this.options.limit&&(t+=`&num=${this.options.limit}`),null!==this.options.key&&(t+=`&key=${this.options.key}`),this._fetchFeed(t)}async _fetchFeed(t){const e=await fetch(t,{headers:{"Content-Type":"application/json"}});return await e.json()}_generateHTMLForEntries(){const t={entries:[],layout:null};return this.entries.forEach((e,s)=>{const i=this.options.offsetStart,n=this.options.offsetEnd;let o;i&&n?s>=i&&s<=n&&this._isRelevant(e,t.entries)&&(o=this._evaluateStringForEntry(this.options.entryTemplate,e),t.entries.push(o)):this._isRelevant(e,t.entries)&&(o=this._evaluateStringForEntry(this.options.entryTemplate,e),t.entries.push(o))}),this.options.entryTemplate?t.layout=this._wrapContent(this.options.layoutTemplate.replace("{entries}","<entries></entries>")):t.layout=this._wrapContent("<div><entries></entries></div>"),t}_isRelevant(t,e){const s=this._getTokenMap(t);return!this.options.filter||(!this.options.filterLimit||this.options.filterLimit!==e.length)&&this.options.filter(t,s)}_applyEffect(t,e,s){}_executeEffectQueue(t){this.effectQueue.reverse();var e=()=>{var s=this.effectQueue.pop();s?this._applyEffect(s.element,s.effect,e):t&&t()};e()}_evaluateStringForEntry(t,e){var s=t;return(t.match(/(\{.*?\})/g)||[]).forEach(t=>{s=s.replace(t,this._getValueForToken(t,e))}),s}_getFormattedDate(t){if(this.options.dateFormatFunction)return this.options.dateFormatFunction(t);if("undefined"!=typeof moment){var e=moment(new Date(t));return(e=e.locale?e.locale(this.options.dateLocale):e.lang(this.options.dateLocale)).format(this.options.dateFormat)}return t}_getTokenMap(t){if(!this.feedTokens){var e=JSON.parse(JSON.stringify(this.feed));delete e.entries,this.feedTokens=e}return{feed:this.feedTokens,url:t.link,author:t.author,date:this._getFormattedDate(t.publishedDate),title:t.title,body:t.content,shortBody:t.contentSnippet,bodyPlain:function(t){for(var e=t.content.replace(/<script[\\r\\\s\S]*<\/script>/gim,"").replace(/<\/?[^>]+>/gi,""),s=0;s<HTML_TAGS.length;s++)e=e.replace(new RegExp("<"+HTML_TAGS[s],"gi"),"");return e}(t),shortBodyPlain:t.contentSnippet.replace(/<\/?[^>]+>/gi,""),index:this.entries.indexOf(t),totalEntries:this.entries.length,teaserImage:function(t){try{return t.content.match(/(<img.*?>)/gi)[0]}catch(t){return""}}(t),teaserImageUrl:function(t){try{return t.content.match(/(<img.*?>)/gi)[0].match(/src=["'](.*?)["']/)[1]}catch(t){return""}}(t),...this.options.tokens}}_getValueForToken(t,e){var s=this._getTokenMap(e),i=s[t.replace(/[\{\}]/g,"")];if(void 0!==i)return"function"==typeof i?i(e,s):i;throw new Error("Unknown token: "+t+", url:"+this.url)}}module.exports=RSS;
